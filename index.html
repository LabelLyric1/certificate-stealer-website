<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Certificate Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/node-forge/1.3.1/forge.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #007AFF;
            --primary-dark: #0056CC;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --dark: #1C1C1E;
            --light: #F2F2F7;
            --gray: #8E8E93;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            overflow: hidden;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .header {
            background: var(--dark);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .description {
            font-size: 16px;
            opacity: 0.9;
            line-height: 1.5;
        }
        
        .content {
            padding: 30px;
        }
        
        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 650px) {
            .upload-section {
                grid-template-columns: 1fr;
            }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
            font-size: 16px;
        }
        
        input[type="file"],
        input[type="password"] {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e1e5e8;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        input:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-button {
            background-color: var(--primary);
            color: white;
            padding: 14px 20px;
            border-radius: 10px;
            cursor: pointer;
            display: inline-block;
            font-weight: 600;
            text-align: center;
            width: 100%;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        
        .file-input-button:hover {
            background-color: var(--primary-dark);
        }
        
        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-name {
            margin-top: 10px;
            font-size: 14px;
            color: var(--gray);
            text-align: center;
        }
        
        .submit-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        
        .submit-btn:disabled {
            background-color: var(--gray);
            cursor: not-allowed;
        }
        
        .submit-btn:not(:disabled):hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .results-section {
            display: none;
            margin-top: 30px;
            border-top: 1px solid #e1e5e8;
            padding-top: 30px;
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .alert {
            padding: 16px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
            text-align: center;
            animation: shake 0.5s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .alert-error {
            background-color: rgba(255, 59, 48, 0.1);
            color: #cc2a22;
            border: 1px solid rgba(255, 59, 48, 0.3);
        }
        
        .alert-success {
            background-color: rgba(52, 199, 89, 0.1);
            color: #28a745;
            border: 1px solid rgba(52, 199, 89, 0.3);
        }
        
        .upload-status {
            margin-top: 20px;
            text-align: center;
            font-size: 15px;
            color: var(--gray);
        }
        
        .privacy-notice {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            font-size: 14px;
            color: var(--gray);
            text-align: center;
            line-height: 1.6;
        }
        
        .certificate-section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            animation: fadeIn 0.5s ease-out;
        }
        
        .certificate-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5e8;
        }
        
        .certificate-icon {
            font-size: 24px;
            margin-right: 15px;
            color: var(--primary);
        }
        
        .certificate-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 12px;
            align-items: flex-start;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .detail-icon {
            width: 24px;
            margin-right: 12px;
            color: var(--primary);
            text-align: center;
        }
        
        .detail-content {
            flex: 1;
        }
        
        .detail-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 4px;
        }
        
        .detail-text {
            color: var(--gray);
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-good {
            background-color: rgba(52, 199, 89, 0.2);
            color: var(--success);
        }
        
        .status-warning {
            background-color: rgba(255, 149, 0, 0.2);
            color: var(--warning);
        }
        
        .status-no {
            background-color: rgba(255, 59, 48, 0.2);
            color: var(--danger);
        }
        
        .divider {
            height: 1px;
            background: #e1e5e8;
            margin: 20px 0;
        }
        
        .entitlements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }
        
        .entitlement-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            background: #f8f9fa;
            transition: transform 0.2s ease;
        }
        
        .entitlement-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .entitlement-status {
            margin-right: 10px;
            font-size: 14px;
        }
        
        .status-enabled {
            color: var(--success);
        }
        
        .status-disabled {
            color: var(--danger);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .devices-list {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .device-item {
            padding: 6px 0;
            border-bottom: 1px solid #e1e5e8;
            font-family: monospace;
            font-size: 12px;
        }
        
        .device-item:last-child {
            border-bottom: none;
        }
        
        .export-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }
        
        .export-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            border: none;
        }
        
        .export-pdf {
            background-color: var(--danger);
            color: white;
        }
        
        .export-pdf:hover {
            background-color: #cc2a22;
            transform: translateY(-2px);
        }
        
        .export-json {
            background-color: var(--primary);
            color: white;
        }
        
        .export-json:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-certificate"></i> Apple Certificate Analyzer</h1>
            <p class="description">Upload your Apple certificate files to verify their validity and details</p>
        </div>
        
        <div class="content">
            <div class="upload-section">
                <div class="form-group">
                    <label for="p12-file"><i class="fas fa-file-export"></i> P12 Certificate File</label>
                    <div class="file-input-container">
                        <div class="file-input-button">Choose P12 File</div>
                        <input type="file" id="p12-file" class="file-input" accept=".p12,.pfx" />
                    </div>
                    <div id="p12-file-name" class="file-name">No file chosen</div>
                </div>
                
                <div class="form-group">
                    <label for="mobileprovision-file"><i class="fas fa-file-contract"></i> Mobile Provisioning Profile</label>
                    <div class="file-input-container">
                        <div class="file-input-button">Choose Mobile Provision File</div>
                        <input type="file" id="mobileprovision-file" class="file-input" accept=".mobileprovision" />
                    </div>
                    <div id="mobileprovision-file-name" class="file-name">No file chosen</div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="password"><i class="fas fa-lock"></i> Certificate Password</label>
                <input type="password" id="password" placeholder="Enter certificate password" />
            </div>
            
            <button id="submit-btn" class="submit-btn" disabled><i class="fas fa-search"></i> Analyze Certificate</button>
            
            <div id="upload-status" class="upload-status"></div>
            
            <div id="error-alert" class="alert alert-error"></div>
            <div id="success-alert" class="alert alert-success"></div>
            
            <div id="results-section" class="results-section">
                <div class="certificate-section">
                    <div class="certificate-header">
                        <div class="certificate-icon"><i class="fas fa-id-card"></i></div>
                        <div class="certificate-title">Certificate Details</div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-icon">💼</div>
                        <div class="detail-content">
                            <div class="detail-title">Certificate Name</div>
                            <div class="detail-text" id="cert-name">-</div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-icon">🏢</div>
                        <div class="detail-content">
                            <div class="detail-title">Organization</div>
                            <div class="detail-text" id="cert-organization">-</div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-icon">🔢</div>
                        <div class="detail-content">
                            <div class="detail-title">Serial Number</div>
                            <div class="detail-text" id="cert-serial">-</div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-icon">📊</div>
                        <div class="detail-content">
                            <div class="detail-title">Certificate Status</div>
                            <div class="detail-text">
                                <span class="status-badge" id="cert-status">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-icon">📅</div>
                        <div class="detail-content">
                            <div class="detail-title">Valid From</div>
                            <div class="detail-text" id="cert-valid-from">-</div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-icon">📅</div>
                        <div class="detail-content">
                            <div class="detail-title">Valid To</div>
                            <div class="detail-text" id="cert-valid-to">-</div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-icon">🌎</div>
                        <div class="detail-content">
                            <div class="detail-title">Country</div>
                            <div class="detail-text" id="cert-country">-</div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-icon">🔐</div>
                        <div class="detail-content">
                            <div class="detail-title">Key Algorithm</div>
                            <div class="detail-text" id="cert-algorithm">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="divider"></div>
                
                <div class="certificate-section">
                    <div class="certificate-header">
                        <div class="certificate-icon"><i class="fas fa-mobile-alt"></i></div>
                        <div class="certificate-title">Provisioning Profile Details</div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-icon">📋</div>
                        <div class="detail-content">
                            <div class="detail-title">Provision Name</div>
                            <div class="detail-text" id="prov-name">-</div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-icon">🆔</div>
                        <div class="detail-content">
                            <div class="detail-title">App ID</div>
                            <div class="detail-text" id="prov-appid">-</div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-icon">🏢</div>
                        <div class="detail-content">
                            <div class="detail-title">Team ID</div>
                            <div class="detail-text" id="prov-teamid">-</div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-icon">🏢</div>
                        <div class="detail-content">
                            <div class="detail-title">Team Name</div>
                            <div class="detail-text" id="prov-teamname">-</div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-icon">🏢</div>
                        <div class="detail-content">
                            <div class="detail-title">Enterprise</div>
                            <div class="detail-text">
                                <span class="status-badge" id="prov-enterprise">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-icon">📊</div>
                        <div class="detail-content">
                            <div class="detail-title">Status</div>
                            <div class="detail-text">
                                <span class="status-badge" id="prov-status">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-icon">📅</div>
                        <div class="detail-content">
                            <div class="detail-title">Creation Date</div>
                            <div class="detail-text" id="prov-created">-</div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-icon">📅</div>
                        <div class="detail-content">
                            <div class="detail-title">Expiration</div>
                            <div class="detail-text" id="prov-expiration">-</div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-icon">📱</div>
                        <div class="detail-content">
                            <div class="detail-title">Provisioned Devices</div>
                            <div class="detail-text" id="prov-devices-count">-</div>
                            <div class="devices-list" id="prov-devices-list">
                                <!-- Devices will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-icon">🔐</div>
                        <div class="detail-content">
                            <div class="detail-title">Entitlements</div>
                            <div class="detail-text">↓</div>
                        </div>
                    </div>
                    
                    <div class="entitlements-grid" id="entitlements-list">
                        <!-- Entitlements will be populated here -->
                    </div>
                </div>
                
                <div class="export-buttons">
                    <button class="export-btn export-pdf" id="export-pdf">
                        <i class="fas fa-file-pdf"></i> Export as PDF
                    </button>
                    <button class="export-btn export-json" id="export-json">
                        <i class="fas fa-file-code"></i> Export as JSON
                    </button>
                </div>
            </div>
            
            <div class="privacy-notice">
                <p><i class="fas fa-shield-alt"></i> This tool analyzes your certificate files locally in your browser. No data is sent to any server.</p>
                <p>Your files are processed entirely on your device for your privacy and security.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const p12FileInput = document.getElementById('p12-file');
            const mobileprovisionFileInput = document.getElementById('mobileprovision-file');
            const passwordInput = document.getElementById('password');
            const submitBtn = document.getElementById('submit-btn');
            const p12FileName = document.getElementById('p12-file-name');
            const mobileprovisionFileName = document.getElementById('mobileprovision-file-name');
            const errorAlert = document.getElementById('error-alert');
            const successAlert = document.getElementById('success-alert');
            const uploadStatus = document.getElementById('upload-status');
            const resultsSection = document.getElementById('results-section');
            const entitlementsList = document.getElementById('entitlements-list');
            const exportPdfBtn = document.getElementById('export-pdf');
            const exportJsonBtn = document.getElementById('export-json');
            const devicesList = document.getElementById('prov-devices-list');
            
            let p12File = null;
            let mobileprovisionFile = null;
            let analysisResults = null;
            
            // Update file names when selected
            p12FileInput.addEventListener('change', function(e) {
                if (this.files.length > 0) {
                    p12File = this.files[0];
                    p12FileName.textContent = p12File.name;
                } else {
                    p12File = null;
                    p12FileName.textContent = 'No file chosen';
                }
                updateSubmitButtonState();
            });
            
            mobileprovisionFileInput.addEventListener('change', function(e) {
                if (this.files.length > 0) {
                    mobileprovisionFile = this.files[0];
                    mobileprovisionFileName.textContent = mobileprovisionFile.name;
                } else {
                    mobileprovisionFile = null;
                    mobileprovisionFileName.textContent = 'No file chosen';
                }
                updateSubmitButtonState();
            });
            
            // Enable submit button only when all fields are filled
            function updateSubmitButtonState() {
                if (p12File && mobileprovisionFile && passwordInput.value) {
                    submitBtn.disabled = false;
                } else {
                    submitBtn.disabled = true;
                }
            }
            
            passwordInput.addEventListener('input', updateSubmitButtonState);
            
            // Handle form submission
            submitBtn.addEventListener('click', async function() {
                // Reset alerts
                hideAlert(errorAlert);
                hideAlert(successAlert);
                uploadStatus.textContent = '';
                
                try {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="loading-spinner"></span> Analyzing...';
                    uploadStatus.textContent = 'Checking certificate files...';
                    
                    // Parse the certificate using PKCS12 format
                    const certInfo = await parseP12Certificate(p12File, passwordInput.value);
                    
                    // Parse the mobile provisioning profile
                    const provisionInfo = await parseMobileProvision(mobileprovisionFile);
                    
                    // Validate the certificate against the provisioning profile
                    validateCertificateAgainstProvision(certInfo, provisionInfo);
                    
                    // Store the analysis results
                    analysisResults = {
                        certificate: certInfo,
                        provisioning: provisionInfo
                    };
                    
                    // Display the results
                    displayResults(certInfo, provisionInfo);
                    
                    // Show results
                    resultsSection.style.display = 'block';
                    uploadStatus.textContent = '';
                    
                    // Show success message
                    showAlert(successAlert, 'Certificate analyzed successfully!');
                    
                    // Update button state
                    submitBtn.innerHTML = '<i class="fas fa-search"></i> Analyze Certificate';
                    updateSubmitButtonState();
                    
                } catch (error) {
                    console.error('Error:', error);
                    showAlert(errorAlert, `Error: ${error.message}`);
                    uploadStatus.textContent = '';
                    submitBtn.innerHTML = '<i class="fas fa-search"></i> Analyze Certificate';
                    updateSubmitButtonState();
                }
            });
            
            // Export as PDF
            exportPdfBtn.addEventListener('click', function() {
                if (!analysisResults) return;
                exportAsPDF(analysisResults);
            });
            
            // Export as JSON
            exportJsonBtn.addEventListener('click', function() {
                if (!analysisResults) return;
                exportAsJSON(analysisResults);
            });
            
            async function parseP12Certificate(p12File, password) {
                try {
                    uploadStatus.textContent = 'Reading certificate file...';
                    
                    // Read the file as ArrayBuffer
                    const p12Buffer = await readFileAsArrayBuffer(p12File);
                    
                    uploadStatus.textContent = 'Decrypting certificate...';
                    
                    // Convert ArrayBuffer to binary string
                    const p12Der = new Uint8Array(p12Buffer);
                    const p12Asn1 = forge.asn1.fromDer(forge.util.createBuffer(p12Der));
                    
                    // Decrypt P12 using password
                    const p12 = forge.pkcs12.pkcs12FromAsn1(p12Asn1, password);
                    
                    // Get certificates from P12
                    const certBags = p12.getBags({ bagType: forge.pki.oids.certBag });
                    
                    if (!certBags[forge.pki.oids.certBag] || certBags[forge.pki.oids.certBag].length === 0) {
                        throw new Error('No certificates found in P12 file');
                    }
                    
                    const certBag = certBags[forge.pki.oids.certBag][0];
                    const certificate = certBag.cert;
                    
                    if (!certificate) {
                        throw new Error('Failed to extract certificate from P12');
                    }
                    
                    uploadStatus.textContent = 'Extracting certificate information...';
                    
                    // Extract certificate information
                    const subject = certificate.subject.attributes;
                    let commonName = 'Unknown';
                    let orgName = 'Unknown';
                    let country = 'Unknown';
                    
                    for (const attr of subject) {
                        if (attr.shortName === 'CN') {
                            commonName = attr.value;
                        } else if (attr.shortName === 'O') {
                            orgName = attr.value;
                        } else if (attr.shortName === 'C') {
                            country = attr.value;
                        }
                    }
                    
                    // Calculate validity
                    const validFrom = new Date(certificate.validity.notBefore);
                    const validTo = new Date(certificate.validity.notAfter);
                    const currentDate = new Date();
                    const daysUntilExpiration = Math.floor((validTo - currentDate) / (1000 * 60 * 60 * 24));
                    
                    // Determine status
                    let status = 'Valid';
                    let statusClass = 'status-good';
                    
                    if (daysUntilExpiration < 0) {
                        status = 'Expired';
                        statusClass = 'status-no';
                    } else if (daysUntilExpiration < 30) {
                        status = 'Expiring Soon';
                        statusClass = 'status-warning';
                    }
                    
                    return {
                        serialNumber: certificate.serialNumber,
                        commonName: commonName,
                        organization: orgName,
                        country: country,
                        validFrom: validFrom.toLocaleDateString(),
                        validTo: validTo.toLocaleDateString(),
                        expirationDays: daysUntilExpiration,
                        publicKeyAlgorithm: certificate.siginfo.algorithmOid,
                        signatureAlgorithm: certificate.signatureOid,
                        status: status,
                        statusClass: statusClass
                    };
                } catch (error) {
                    console.error('Error parsing P12:', error);
                    throw new Error('Failed to parse P12 certificate. Invalid password or file.');
                }
            }
            
            async function parseMobileProvision(provisionFile) {
                try {
                    uploadStatus.textContent = 'Reading provisioning profile...';
                    
                    // Read the file as text
                    const provisionText = await readFileAsText(provisionFile);
                    
                    // Find the start and end of the plist content
                    const start = provisionText.indexOf('<?xml');
                    const end = provisionText.indexOf('</plist>') + 8;
                    
                    if (start === -1 || end === -1) {
                        throw new Error('Invalid provisioning profile format');
                    }
                    
                    // Extract the plist content
                    const plistContent = provisionText.substring(start, end);
                    
                    // Parse the plist XML
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(plistContent, 'text/xml');
                    
                    // Helper function to get text content from XML
                    const getTextContent = (tagName) => {
                        const elements = xmlDoc.getElementsByTagName(tagName);
                        return elements.length > 0 ? elements[0].textContent : 'N/A';
                    };
                    
                    // Get entitlements
                    const entitlements = {};
                    const entitlementElements = xmlDoc.getElementsByTagName('key');
                    for (let i = 0; i < entitlementElements.length; i++) {
                        const key = entitlementElements[i].textContent;
                        if (key.includes('entitlement') || key.includes('com.apple')) {
                            const valueElement = entitlementElements[i].nextElementSibling;
                            if (valueElement) {
                                if (valueElement.tagName === 'true') {
                                    entitlements[key] = true;
                                } else if (valueElement.tagName === 'false') {
                                    entitlements[key] = false;
                                } else {
                                    entitlements[key] = valueElement.textContent;
                                }
                            }
                        }
                    }
                    
                    // Get provisioned devices
                    const devices = [];
                    const deviceElements = xmlDoc.getElementsByTagName('string');
                    for (let i = 0; i < deviceElements.length; i++) {
                        const text = deviceElements[i].textContent;
                        // Check if it looks like a device UDID
                        if (text.length === 40 && /^[a-fA-F0-9]+$/.test(text)) {
                            devices.push(text);
                        }
                    }
                    
                    // Get creation and expiration dates
                    const creationDate = new Date(getTextContent('CreationDate'));
                    const expirationDate = new Date(getTextContent('ExpirationDate'));
                    const currentDate = new Date();
                    const daysUntilExpiration = Math.floor((expirationDate - currentDate) / (1000 * 60 * 60 * 24));
                    
                    // Determine status
                    let status = 'Valid';
                    let statusClass = 'status-good';
                    
                    if (daysUntilExpiration < 0) {
                        status = 'Expired';
                        statusClass = 'status-no';
                    } else if (daysUntilExpiration < 30) {
                        status = 'Expiring Soon';
                        statusClass = 'status-warning';
                    }
                    
                    // Check if it's an enterprise profile
                    const isEnterprise = getTextContent('ProvisionsAllDevices') === 'true';
                    
                    return {
                        name: getTextContent('Name'),
                        appId: getTextContent('application-identifier'),
                        teamId: getTextContent('com.apple.developer.team-identifier'),
                        teamName: getTextContent('TeamName'),
                        creationDate: creationDate.toLocaleDateString(),
                        expirationDate: expirationDate.toLocaleDateString(),
                        expirationDays: daysUntilExpiration,
                        status: status,
                        statusClass: statusClass,
                        isEnterprise: isEnterprise,
                        entitlements: entitlements,
                        devices: devices
                    };
                } catch (error) {
                    console.error('Error parsing provisioning profile:', error);
                    throw new Error('Failed to parse provisioning profile. Invalid file format.');
                }
            }
            
            function validateCertificateAgainstProvision(certInfo, provisionInfo) {
                // Check if certificate is expired
                if (certInfo.status === 'Expired') {
                    throw new Error('Certificate has expired');
                }
                
                // Check if provisioning profile is expired
                if (provisionInfo.status === 'Expired') {
                    throw new Error('Provisioning profile has expired');
                }
                
                // Additional validation logic could be added here
                // For example, checking if the certificate is included in the provisioning profile
                
                return true;
            }
            
            function readFileAsArrayBuffer(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }
            
            function readFileAsText(file) {
                return new Promise((resolve, reject) {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }
            
            function displayResults(certResults, provResults) {
                // Display certificate details
                document.getElementById('cert-name').textContent = certResults.commonName;
                document.getElementById('cert-organization').textContent = certResults.organization;
                document.getElementById('cert-serial').textContent = certResults.serialNumber;
                document.getElementById('cert-status').textContent = certResults.status;
                document.getElementById('cert-status').className = `status-badge ${certResults.statusClass}`;
                document.getElementById('cert-valid-from').textContent = certResults.validFrom;
                document.getElementById('cert-valid-to').textContent = certResults.validTo;
                document.getElementById('cert-country').textContent = certResults.country;
                document.getElementById('cert-algorithm').textContent = certResults.publicKeyAlgorithm;
                
                // Display provisioning profile details
                document.getElementById('prov-name').textContent = provResults.name;
                document.getElementById('prov-appid').textContent = provResults.appId;
                document.getElementById('prov-teamid').textContent = provResults.teamId;
                document.getElementById('prov-teamname').textContent = provResults.teamName;
                document.getElementById('prov-enterprise').textContent = provResults.isEnterprise ? 'Yes' : 'No';
                document.getElementById('prov-enterprise').className = `status-badge ${provResults.isEnterprise ? 'status-good' : 'status-no'}`;
                document.getElementById('prov-status').textContent = provResults.status;
                document.getElementById('prov-status').className = `status-badge ${provResults.statusClass}`;
                document.getElementById('prov-created').textContent = provResults.creationDate;
                document.getElementById('prov-expiration').textContent = provResults.expirationDate;
                document.getElementById('prov-devices-count').textContent = `${provResults.devices.length} devices provisioned`;
                
                // Display devices
                devicesList.innerHTML = '';
                if (provResults.devices.length > 0) {
                    provResults.devices.forEach(device => {
                        const deviceItem = document.createElement('div');
                        deviceItem.className = 'device-item';
                        deviceItem.textContent = device;
                        devicesList.appendChild(deviceItem);
                    });
                } else if (provResults.isEnterprise) {
                    const deviceItem = document.createElement('div');
                    deviceItem.className = 'device-item';
                    deviceItem.textContent = 'Enterprise profile - all devices allowed';
                    devicesList.appendChild(deviceItem);
                } else {
                    const deviceItem = document.createElement('div');
                    deviceItem.className = 'device-item';
                    deviceItem.textContent = 'No devices found (App Store profile)';
                    devicesList.appendChild(deviceItem);
                }
                
                // Display entitlements
                entitlementsList.innerHTML = '';
                for (const [key, value] of Object.entries(provResults.entitlements)) {
                    const entitlementItem = document.createElement('div');
                    entitlementItem.className = 'entitlement-item';
                    
                    const statusIcon = document.createElement('span');
                    statusIcon.className = `entitlement-status ${value ? 'status-enabled' : 'status-disabled'}`;
                    statusIcon.innerHTML = value ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>';
                    
                    const entitlementText = document.createElement('span');
                    entitlementText.textContent = key;
                    
                    entitlementItem.appendChild(statusIcon);
                    entitlementItem.appendChild(entitlementText);
                    entitlementsList.appendChild(entitlementItem);
                }
            }
            
            function showAlert(alertElement, message) {
                alertElement.textContent = message;
                alertElement.style.display = 'block';
            }
            
            function hideAlert(alertElement) {
                alertElement.style.display = 'none';
            }
            
            function exportAsPDF(results) {
                // This would use jsPDF to create a PDF document
                alert('PDF export functionality would be implemented here. In a real application, this would generate a detailed PDF report of the certificate analysis.');
            }
            
            function exportAsJSON(results) {
                // Create a JSON string from the results
                const jsonString = JSON.stringify(results, null, 2);
                
                // Create a Blob from the JSON string
                const blob = new Blob([jsonString], { type: 'application/json' });
                
                // Create a download link
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'certificate-analysis.json';
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            }
        });
    </script>
</body>
</html>
